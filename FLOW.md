# 付款流程圖

## 完整交易流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        使用者掃描 QR Code                        │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                     1. 訂單確認頁 (index.html)                   │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ • 顯示訂單資訊（商品、金額、販賣機編號）                  │  │
│  │ • 選擇發票類型（個人/公司）                               │  │
│  │ • 輸入發票資訊（載具/統編）                               │  │
│  │ • 選擇付款方式（信用卡/LINE Pay）                         │  │
│  │ • 驗證表單資料                                            │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────┘
                             │
                ┌────────────┴────────────┐
                │                         │
                ▼                         ▼
┌─────────────────────────┐   ┌─────────────────────────┐
│   選擇「信用卡」        │   │   選擇「LINE Pay」      │
└───────────┬─────────────┘   └───────────┬─────────────┘
            │                             │
            ▼                             ▼
┌─────────────────────────┐   ┌─────────────────────────┐
│ 2a. 信用卡付款頁        │   │ 2b. LINE Pay 付款頁     │
│ (credit-card.html)      │   │ (linepay.html)          │
│                         │   │                         │
│ • 顯示訂單摘要          │   │ 【載入階段】            │
│ • 輸入卡號              │   │ • 模擬 Request API      │
│ • 輸入持卡人姓名        │   │ • 顯示載入動畫          │
│ • 輸入有效期限 (MM/YY)  │   │                         │
│ • 輸入 CVV (3-4碼)      │   │ 【確認階段】            │
│ • 自動格式化            │   │ • 顯示訂單資訊          │
│ • Luhn 演算法驗證       │   │ • 顯示商品明細          │
│ • 卡片類型偵測          │   │ • 20分鐘倒數計時        │
│                         │   │ • 確認/取消按鈕         │
│ 點擊「確認付款」        │   │                         │
│         ↓               │   │ 點擊「確認付款」        │
│ • 禁用按鈕              │   │         ↓               │
│ • 顯示處理中動畫        │   │ 【處理階段】            │
│ • 模擬金流商授權        │   │ • 模擬 Confirm API      │
│ • 2秒延遲               │   │ • 顯示處理中動畫        │
│                         │   │ • 2秒延遲               │
└───────────┬─────────────┘   └───────────┬─────────────┘
            │                             │
            │        ┌────────────────────┘
            │        │
            └────────┴─────────┐
                               ▼
            ┌──────────────────────────────┐
            │    模擬付款結果（隨機）      │
            │  • 成功率：信用卡 90%        │
            │  • 成功率：LINE Pay 95%      │
            └────────────┬─────────────────┘
                         │
            ┌────────────┴────────────┐
            │                         │
            ▼                         ▼
┌─────────────────────┐   ┌─────────────────────┐
│    付款成功         │   │    付款失敗         │
└──────────┬──────────┘   └──────────┬──────────┘
           │                         │
           └─────────┬───────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────────┐
│                 3. 付款完成頁 (complete.html)                    │
│                                                                  │
│  ┌────────────────────┐         ┌────────────────────┐         │
│  │   【成功狀態】     │         │   【失敗狀態】     │         │
│  │                    │         │                    │         │
│  │  ✓ 綠色圖示        │         │  ✗ 紅色圖示        │         │
│  │  付款成功          │         │  付款失敗          │         │
│  │                    │         │                    │         │
│  │  • 交易編號        │         │  • 失敗原因        │         │
│  │  • 付款金額        │         │  • 交易編號        │         │
│  │  • 付款方式        │         │                    │         │
│  │  • 電子發票號碼    │         │  [重新付款]        │         │
│  │                    │         │  [取消訂單]        │         │
│  │  商品出貨中...     │         │                    │         │
│  │                    │         │                    │         │
│  │  10秒倒數自動關閉  │         │                    │         │
│  └────────┬───────────┘         └────────┬───────────┘         │
│           │                              │                      │
│           ▼                              ▼                      │
│   通知販賣機出貨                   返回訂單頁重試               │
└─────────────────────────────────────────────────────────────────┘
```

## 頁面轉換說明

### 1. index.html → credit-card.html
- **觸發條件**: 選擇信用卡付款 + 點擊確認按鈕
- **資料傳遞**: sessionStorage 存入 paymentData
- **延遲時間**: 0.5秒

### 2. index.html → linepay.html
- **觸發條件**: 選擇 LINE Pay + 點擊確認按鈕
- **資料傳遞**: sessionStorage 存入 paymentData
- **延遲時間**: 0.5秒

### 3. credit-card.html → complete.html
- **觸發條件**: 驗證通過 + 點擊確認付款
- **模擬處理**: 2秒金流授權
- **成功機率**: 90%
- **URL 參數**: ?status=success 或 ?status=failure

### 4. linepay.html → complete.html
- **觸發條件**: 點擊確認付款
- **模擬階段**:
  1. Request API (1.5秒)
  2. 顯示確認頁 + 倒數計時 (最多20分鐘)
  3. Confirm API (2秒)
- **成功機率**: 95%
- **URL 參數**: ?status=success 或 ?status=failure&reason=xxx

### 5. complete.html 自動關閉/返回
- **成功**: 10秒倒數後返回 index.html
- **失敗**: 手動點擊「重新付款」返回 index.html

## 資料流動

### sessionStorage 儲存的資料結構
```javascript
{
  "invoiceType": "personal" | "company",
  "paymentMethod": "credit" | "linepay",
  "totalAmount": 60,
  "machineId": "VM-TPE-001",

  // 個人發票
  "carrierType": "mobile" | "certificate" | "none",
  "carrierId": "/ABC1234",
  "donationCode": "9999",

  // 公司發票
  "taxId": "12345678",
  "companyTitle": "台灣科技股份有限公司"
}
```

## 驗證流程

### 訂單頁驗證
1. 檢查發票類型
2. 如為公司：驗證統編格式、抬頭必填
3. 如為個人：驗證載具格式（若有填寫）、捐贈碼格式（若有填寫）
4. 所有驗證通過才允許進入付款頁

### 信用卡驗證
1. 卡號：Luhn 演算法 + 13-19碼
2. 持卡人：至少2個字元
3. 有效期限：MM/YY 格式 + 未過期
4. CVV：3-4碼數字

### LINE Pay 驗證
- 僅需確認訂單資訊
- 倒數計時超過20分鐘自動失敗

## 錯誤處理

### 表單驗證錯誤
- 紅框標示錯誤欄位
- 顯示錯誤訊息
- 滾動到第一個錯誤

### 付款失敗
- 顯示失敗原因
- 提供重試選項
- 保留訂單資料

### 頁面異常
- 缺少 sessionStorage：自動返回首頁
- 付款超時：導向失敗頁
- 使用者取消：導向失敗頁
